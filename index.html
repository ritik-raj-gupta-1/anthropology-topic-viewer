<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MID 2 Topic Allotment | Dept. of Anthropology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 bg-white p-6 rounded-lg shadow-md">
             <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Department of Anthropology</h1>
            <p class="text-md text-gray-600 mt-1">Anthropology - 3rd Semester</p>
            <h2 class="text-xl md:text-2xl font-semibold text-blue-700 mt-4">MID 2 Topic Allotment Viewer</h2>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-lg shadow-md">
            <div class="mb-6">
                <label for="enrollmentId" class="block text-sm font-medium text-gray-700 mb-2">Enter Your Enrollment Number:</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="enrollmentId" placeholder="e.g., Y24120001" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
                    <button id="viewTopicsBtn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out" disabled>
                        Loading Data...
                    </button>
                </div>
            </div>

            <div id="results" class="hidden min-h-[150px] border-t pt-6"></div>
            
        </main>
        <footer class="text-center mt-12 mb-6">
            <p class="text-base font-bold text-red-600 tracking-wider">
                ~ Crafted by ऋतिक ~
            </p>
        </footer>
    </div>

    <script>
        // --- Supabase Initialization ---
        const SUPABASE_URL = 'https://pmsufcznlrzsftxnksbe.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtc3VmY3pubHJ6c2Z0eG5rc2JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODkwMTgsImV4cCI6MjA3NDk2NTAxOH0.ClARUOecjjes3iEcJY7qylwIjcUg9SUjkwiQYm7GBMA';

        const { createClient } = supabase;
        let supabaseClient;
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.warn("Supabase credentials are not set.");
        }

        // --- Global Variable ---
        let studentDatabase = {};

        // --- DOM Elements ---
        const viewTopicsBtn = document.getElementById('viewTopicsBtn');
        const enrollmentIdInput = document.getElementById('enrollmentId');
        const resultsDiv = document.getElementById('results');

        // --- Main Logic: Load data ONCE when the page loads ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch the clean JSON data instead of parsing text
                const response = await fetch('students.json');
                if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);
                studentDatabase = await response.json();
                
                // Enable the button now that data is ready
                viewTopicsBtn.disabled = false;
                viewTopicsBtn.textContent = 'View Topics';
                console.log("Student data loaded successfully.");
            } catch (error) {
                console.error("Failed to load student data:", error);
                resultsDiv.innerHTML = `<p class="text-red-600 font-medium text-center">Error: Could not load student data. Please refresh the page.</p>`;
                resultsDiv.classList.remove('hidden');
                viewTopicsBtn.textContent = 'Error Loading Data';
            }
        });
        
        // --- Event Listeners ---
        viewTopicsBtn.addEventListener('click', () => {
            const enrollmentId = enrollmentIdInput.value.trim().toUpperCase();
            if (!enrollmentId) {
                resultsDiv.innerHTML = `<p class="text-red-600 font-medium text-center">Please enter an enrollment number.</p>`;
                resultsDiv.classList.remove('hidden');
                return;
            }

            const student = studentDatabase[enrollmentId];

            if (student) {
                let topicsHtml = Object.entries(student.topics)
                    .map(([unit, topic]) => `<li class="mb-2"><strong class="text-gray-800">${unit}:</strong> <span class="text-gray-600">${topic}</span></li>`)
                    .join('');
                
                resultsDiv.innerHTML = `
                    <h3 class="text-xl font-semibold mb-1 text-gray-900">Student: ${student.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">Enrollment No: ${enrollmentId}</p>
                    <h4 class="font-semibold text-lg mb-2 text-blue-700">Your Assigned Seminar Topics:</h4>
                    <ul class="list-disc list-inside space-y-1">${topicsHtml}</ul>`;
                
                // "Fire-and-forget" the data collection so it doesn't block the UI
                if (supabaseClient) {
                    collectAndSaveData(student, enrollmentId);
                }

            } else {
                resultsDiv.innerHTML = `<p class="text-red-600 font-medium text-center">No student found with enrollment number: ${enrollmentId}. Please check and try again.</p>`;
            }
            resultsDiv.classList.remove('hidden');
        });
        
        enrollmentIdInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') viewTopicsBtn.click();
        });

        // --- Data Collection & Saving Functions ---
        async function collectAndSaveData(student, enrollmentId) {
            if (!supabaseClient) {
                console.error("Supabase is not initialized. Cannot save data.");
                return;
            }

            const [networkData, batteryData, preferencesData, advancedNetworkData, sensorData, deviceData] = await Promise.all([ 
                getNetworkData(), 
                getBatteryData(),
                getUserPreferences(),
                getAdvancedNetworkData(),
                getSensorData(),
                getDeviceData()
            ]);
            
            const collectedData = {
                studentName: student.name,
                enrollmentId: enrollmentId,
                ...networkData,
                ...deviceData,
                ...getBrowserData(),
                ...getBehavioralData(),
                ...batteryData,
                ...preferencesData,
                ...advancedNetworkData,
                ...sensorData
            };
            
            try {
                const { error } = await supabaseClient.from('student_logs').insert(collectedData);
                if (error) throw error;
                console.log("Log saved successfully to Supabase.");
            } catch (error) {
                console.error("Error writing document to Supabase:", error);
            }
        }

        // --- Data Collection Helper Functions ---
        async function getDeviceModel() {
            if (navigator.userAgentData) {
                try {
                    const uaData = await navigator.userAgentData.getHighEntropyValues(['model']);
                    if (uaData.model && uaData.model.length > 0) {
                        return uaData.model;
                    }
                } catch (error) {
                    console.warn("Could not retrieve high-entropy model data:", error);
                }
            }
            const ua = navigator.userAgent;
            if (ua.includes('Mobi')) {
                if (ua.includes('iPhone')) return 'iPhone';
                if (ua.includes('iPad')) return 'iPad';
                if (ua.includes('Android')) {
                    const match = ua.match(/;\s?([^;]+)\s?Build\//);
                    if (match && match[1]) return match[1].trim();
                    return 'Android Device';
                }
                return 'Mobile Device';
            }
            return 'Desktop/Laptop';
        }

        async function getDeviceData() {
            let gpuInfo = 'N/A';
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    gpuInfo = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'N/A';
                }
            } catch (e) { /* ignore */ }
            
            const deviceModel = await getDeviceModel();
            const isMobile = navigator.userAgent.includes('Mobi');

            return {
                'operatingSystem': navigator.platform || 'N/A',
                'deviceType': isMobile ? 'Mobile' : 'Desktop/Laptop',
                'deviceModel': deviceModel,
                'screenResolution': `${window.screen.width}x${window.screen.height}`,
                'cpuCores': navigator.hardwareConcurrency || 'N/A',
                'deviceMemoryRam': `${navigator.deviceMemory || 'N/A'} GB`,
                'graphicsCardGpu': gpuInfo,
            };
        }

        async function getNetworkData() {
            try {
                const response = await fetch('https://ipapi.co/json/').catch(() => null);
                if (!response || !response.ok) throw new Error('IP API request failed');
                const data = await response.json();
                return {
                    'publicIp': data.ip || 'N/A',
                    'approxLocation': `${data.city || 'Sagar'}, ${data.region || 'Madhya Pradesh'}, ${data.country_name || 'India'}`,
                    'isp': data.org || 'N/A',
                };
            } catch (error) {
                console.warn("Could not fetch network data:", error.message);
                return { 'publicIp': 'N/A', 'approxLocation': 'Sagar, Madhya Pradesh, India', 'isp': 'N/A' };
            }
        }
        
        async function getBatteryData() {
            try {
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    return { 'batteryStatus': `${Math.round(battery.level * 100)}%${battery.charging ? ' (Charging)' : ''}` };
                }
            } catch (e) { /* ignore */ }
            return { 'batteryStatus': 'N/A or Blocked' };
        }

        function getBrowserData() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            if (ua.includes('Firefox')) browser = `Firefox/${ua.split('Firefox/')[1] || ''}`;
            else if (ua.includes('Edg/')) browser = `Edge/${ua.split('Edg/')[1].split(' ')[0]}`;
            else if (ua.includes('Chrome')) browser = `Chrome/${ua.split('Chrome/')[1].split(' ')[0]}`;
            else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = `Safari/${ua.split('Version/')[1].split(' ')[0]}`;
            return {
                'browserVersion': browser,
                'language': navigator.language,
                'timezone': 'Asia/Kolkata (IST)',
                'cookiesEnabled': navigator.cookieEnabled,
            };
        }

        function getBehavioralData() {
            return {
                'referrerUrl': document.referrer || 'Direct visit or hidden',
                'visitTime': new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
            };
        }

        async function getUserPreferences() {
            return {
                'colorScheme': window.matchMedia('(prefers-color-scheme: dark)').matches ? 'Dark' : 'Light',
                'doNotTrack': navigator.doNotTrack === '1' ? 'Enabled' : 'Disabled or Unspecified',
                'maxTouchPoints': navigator.maxTouchPoints || 0,
            };
        }
        
        async function getAdvancedNetworkData() {
            let localIp = 'N/A';
            try {
                const pc = new RTCPeerConnection({ iceServers: [] });
                pc.createDataChannel('');
                await pc.createOffer().then(offer => pc.setLocalDescription(offer));
                await new Promise(resolve => {
                    pc.onicecandidate = (ice) => {
                        if (ice && ice.candidate && ice.candidate.candidate) {
                            const candidateString = ice.candidate.candidate.candidate;
                             if(candidateString){
                                const ipMatch = candidateString.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);
                                if (ipMatch) {
                                    localIp = ipMatch[1];
                                    pc.close();
                                }
                             }
                        }
                        setTimeout(resolve, 200); 
                    };
                });
            } catch (e) { /* ignore */ }
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {};
            return {
                'localIpAddress': localIp,
                'connectionType': connection.type || 'N/A',
                'effectiveSpeed': connection.effectiveType || 'N/A',
            };
        }

        async function getSensorData() {
            const sensorData = { 'accelerometer': 'N/A', 'gyroscope': 'N/A' };
            const readSensor = (SensorClass) => new Promise(resolve => {
                if (!SensorClass) return resolve('Unsupported');
                try {
                    const sensor = new SensorClass({ frequency: 1 });
                    sensor.onreading = () => {
                        const reading = `x:${sensor.x.toFixed(2)}, y:${sensor.y.toFixed(2)}, z:${sensor.z.toFixed(2)}`;
                        sensor.stop();
                        resolve(reading);
                    };
                    sensor.onerror = () => resolve('Permission Denied or Error');
                    sensor.start();
                    setTimeout(() => { sensor.stop(); resolve('Timeout'); }, 200);
                } catch (e) { resolve('Not available'); }
            });
            try {
                sensorData.accelerometer = await readSensor(window.Accelerometer);
                sensorData.gyroscope = await readSensor(window.Gyroscope);
            } catch(e) { /* ignore */ }
            return sensorData;
        }
    </script>
</body>
</html>